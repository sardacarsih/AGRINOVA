# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Agrinova is a multi-tenant palm oil plantation management system with offline-first mobile support. The system consists of three applications:

- **Go Backend** (`apps/golang/`): GraphQL API with gqlgen, Gin router, PostgreSQL/GORM, JWT + Cookie auth
- **Flutter Mobile** (`apps/mobile/`): Offline-first app with SQLite sync for field operations
- **Next.js Web** (`apps/web/`): Dashboard with Apollo Client, React 19, Tailwind CSS

## Development Commands

### Backend (Go GraphQL)
```bash
cd apps/golang
go run ./cmd/server/main.go          # Start server (port 8080)
go generate ./...                     # Regenerate GraphQL code after schema changes
go run ./cmd/seed/main.go            # Seed database
go test ./...                        # Run all tests
go test -v ./internal/auth/...       # Run tests for specific package
go test -run TestFunctionName ./...  # Run single test
```

### Web (Next.js)
```bash
cd apps/web
npm run dev                          # Start dev server with Turbopack (port 3000)
npm run build                        # Production build
npm run lint                         # Run ESLint
npm run lint:fix                     # Fix linting issues
npm run type-check                   # TypeScript type checking
npm run test                         # Run Jest tests
npm run test:watch                   # Run tests in watch mode
npm run storybook                    # Launch Storybook (port 6006)
```

### Mobile (Flutter)
```bash
cd apps/mobile
flutter pub get                      # Get dependencies
flutter run                          # Run on connected device
flutter run -d <device-id>           # Run on specific device
flutter build apk --release          # Build release APK
dart run build_runner build --delete-conflicting-outputs  # Generate code
flutter test                         # Run all tests
flutter test test/unit/auth/         # Run tests in specific directory
flutter analyze                      # Static analysis
dart format .                        # Format code
```

## Architecture

### Role-Based System

| Role | Platform | Offline | Purpose |
|------|----------|---------|---------|
| MANDOR | Mobile | Yes | Harvest input, field sync |
| SATPAM | Mobile | Yes | Gate check, QR scanning |
| ASISTEN | Mobile | No | Approval workflow |
| MANAGER | Mobile/Web | No | Estate monitoring |
| TIMBANGAN | Mobile/Web | No | Weighing operations |
| GRADING | Mobile/Web | No | TBS quality grading |
| AREA_MANAGER | Web | No | Multi-company analytics |
| COMPANY_ADMIN | Web | No | User management |
| SUPER_ADMIN | Web | No | Multi-tenant admin |

### Backend Structure (Go)

The backend uses domain-driven design with role-specific GraphQL schemas:

```
apps/golang/
├── cmd/
│   ├── server/main.go              # Entry point with Gin router
│   └── seed/main.go                # Database seeding
├── internal/
│   ├── graphql/
│   │   ├── schema/*.graphqls       # Role-specific schemas (mandor, satpam, manager, etc.)
│   │   ├── resolvers/              # gqlgen resolver implementations
│   │   ├── generated/              # Auto-generated by gqlgen
│   │   ├── domain/                 # Domain models (auth, master, mandor, satpam, etc.)
│   │   ├── directives/             # Auth directives (@auth, @hasRole)
│   │   └── scalars/                # Custom scalars (Time)
│   ├── auth/                       # JWT, cookies, device binding, RBAC
│   ├── master/                     # Company, Estate, Division, Block
│   ├── panen/                      # Harvest records
│   ├── gatecheck/                  # Gate check and QR tokens
│   ├── rbac/                       # Role-based access control services
│   ├── notifications/              # FCM push notifications
│   ├── middleware/                 # Auth, RLS context, rate limiting
│   └── websocket/                  # Real-time subscriptions
└── pkg/
    ├── config/                     # Viper configuration
    ├── database/                   # GORM setup, migrations, seeds
    ├── fcm/                        # Firebase Cloud Messaging
    └── logger/                     # Logging utilities
```

### GraphQL Schema Organization

Schemas are organized by role in `apps/golang/internal/graphql/schema/`:
- `auth.graphqls` - Authentication mutations (mobileLogin, webLogin, refreshToken)
- `master.graphqls` - Company, Estate, Division, Block queries
- `mandor.graphqls` - Harvest input and sync operations
- `satpam.graphqls` - Gate check, QR tokens, guest registration
- `manager.graphqls` - Analytics and monitoring
- `rbac.graphqls` - Roles and permissions management
- `features.graphqls` - Feature flags

### Web Structure (Next.js)
```
apps/web/
├── app/                            # Next.js App Router pages
├── components/
│   ├── ui/                         # Radix UI + shadcn components
│   ├── dashboard/                  # Dashboard components
│   └── auth/                       # Login, protected routes
├── lib/
│   ├── apollo/                     # Apollo Client, queries, WebSocket subscriptions
│   │   ├── client.ts               # Apollo client with cookie auth
│   │   ├── websocket.ts            # WebSocket link for subscriptions
│   │   └── queries/                # GraphQL query/mutation definitions
│   └── auth/                       # Auth provider, permissions
└── hooks/                          # React hooks (use-auth, use-graphql-subscriptions)
```

### Mobile Structure (Flutter)
```
apps/mobile/lib/
├── core/
│   ├── di/                         # GetIt dependency injection
│   ├── services/                   # JWT, sync, database services
│   ├── graphql/                    # GraphQL queries and mutations
│   └── routes/                     # GoRouter navigation
├── features/                       # Feature modules (Clean Architecture)
│   ├── auth/                       # Login, biometrics (data/domain/presentation)
│   ├── harvest/                    # Harvest input
│   ├── gate_check/                 # QR scanning, guest registration
│   └── dashboard/                  # Role-specific dashboards
└── shared/                         # Shared widgets
```

## Key Patterns

### GraphQL Schema Changes
1. Edit schema files in `apps/golang/internal/graphql/schema/`
2. Add type mappings in `gqlgen.yml` if using custom domain models
3. Run `go generate ./...` in `apps/golang/`
4. Implement new resolvers in `apps/golang/internal/graphql/resolvers/`

### Authentication

**Web (Cookie-based)**:
- Uses `webLogin` mutation which sets HttpOnly cookies
- Apollo Client configured with `credentials: 'include'`
- Requests proxied through Next.js API route `/api/graphql`

**Mobile (JWT-based)**:
- Uses `mobileLogin` mutation returning JWT tokens
- Three-tier token system: Access (15min), Refresh (7d), Offline (30d)
- Tokens stored in Flutter Secure Storage

### Offline Sync (Mobile)
- Only MANDOR and SATPAM roles support offline-first
- Data flows: User Input → SQLite → sync_queue → Background Sync → GraphQL API
- Conflict resolution is server-authoritative
- Sync triggered on connectivity change, manual pull-to-refresh, or background timer

### State Management
- **Web**: Apollo Client cache for server state, Zustand for local state
- **Mobile**: BLoC pattern with flutter_bloc, Repository pattern for data layer

### Database
- PostgreSQL with Row-Level Security (RLS) for multi-tenancy
- GORM for ORM with auto-migrations
- RLS context set via `middleware/rls_context.go` for security

### WebSocket Subscriptions
- Server uses gorilla/websocket with gqlgen transport
- Web uses graphql-ws protocol via Apollo Client split link
- Mobile uses graphql_flutter package

## Environment Configuration

### Backend (.env)
```
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=agrinova
DATABASE_PASSWORD=password
DATABASE_NAME=agrinova
JWT_ACCESS_SECRET=your-secret
JWT_REFRESH_SECRET=your-secret
JWT_OFFLINE_SECRET=your-secret
COOKIE_DOMAIN=localhost
CORS_ALLOWED_ORIGINS=http://localhost:3000
SERVER_PORT=8080
```

### Web (.env.local)
```
BACKEND_GRAPHQL_URL=http://127.0.0.1:8080
NEXT_PUBLIC_GRAPHQL_URL=/api/graphql
NEXT_PUBLIC_WS_URL=ws://127.0.0.1:8080/graphql
```

### Mobile (lib/core/config/)
- Configuration managed in `app_config.dart`
- API URLs configured per environment (dev/staging/production)

## Testing

### Go
```bash
go test ./...                              # All tests
go test -v ./internal/auth/services/...    # Specific package with verbose output
go test -run TestUserService ./...         # Single test by name
go test -cover ./...                       # With coverage
```

### Web
```bash
npm run test                    # Jest tests
npm run test:watch              # Watch mode
npm run test:coverage           # With coverage report
```

### Mobile
```bash
flutter test                                    # All tests
flutter test test/unit/auth/auth_bloc_test.dart # Specific test file
flutter test --coverage                         # With coverage
flutter test integration_test/                  # Integration tests
```

## Demo Credentials

- **Super Admin**: `super-admin@agrinova.com` / `admin123`
- **Company Admin**: `company-admin@agrinova.com` / `admin123`
- **Manager**: `manager-agrinova@agrinova.com` / `admin123`
- **Quick Login**: `admin` / `admin123`, `manager` / `admin123`
