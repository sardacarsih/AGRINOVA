name: Android Release

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/android-release.yml'
  workflow_dispatch:
    inputs:
      target_track:
        description: 'Manual run target track (non-production only)'
        type: choice
        required: true
        default: internal
        options:
          - internal
          - closed
      version_name:
        description: 'Optional Android versionName override'
        required: false
        default: ''
      version_code:
        description: 'Optional Android versionCode override'
        required: false
        default: ''
      source_commit:
        description: 'Commit SHA from latest successful develop internal artifact (required for closed promotion)'
        required: false
        default: ''

permissions:
  contents: read
  actions: read

concurrency:
  group: android-release-mobile
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.38.9'
  JAVA_VERSION: '17'
  ANDROID_MAX_VERSION_CODE: '2100000000'

jobs:
  plan:
    name: Plan Release Track and Version
    runs-on: ubuntu-latest
    outputs:
      track: ${{ steps.plan.outputs.track }}
      play_track: ${{ steps.plan.outputs.play_track }}
      environment: ${{ steps.plan.outputs.environment }}
      is_production: ${{ steps.plan.outputs.is_production }}
      requires_build: ${{ steps.plan.outputs.requires_build }}
      source_commit: ${{ steps.plan.outputs.source_commit }}
      artifact_name: ${{ steps.plan.outputs.artifact_name }}
      version_name: ${{ steps.plan.outputs.version_name }}
      version_code: ${{ steps.plan.outputs.version_code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Resolve track and version
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          event_name="${{ github.event_name }}"
          ref_type="${{ github.ref_type }}"
          ref_name="${{ github.ref_name }}"

          track=""
          play_track=""
          environment=""
          is_production="false"
          requires_build="true"
          source_commit="${GITHUB_SHA}"
          artifact_name=""
          version_name=""
          version_code=""

          if [[ "$event_name" == "push" && "$ref_type" == "branch" ]]; then
            if [[ "$ref_name" == "develop" ]]; then
              track="internal"
              play_track="internal"
              environment="mobile-internal"
            elif [[ "$ref_name" == "main" ]]; then
              track="closed"
              play_track="alpha"
              environment="mobile-closed"
              requires_build="false"
              if git rev-parse --verify HEAD^2 >/dev/null 2>&1; then
                source_commit="$(git rev-parse HEAD^2)"
              fi
            else
              echo "::error::Unsupported branch '$ref_name'. Allowed: develop, main."
              exit 1
            fi
          elif [[ "$event_name" == "push" && "$ref_type" == "tag" ]]; then
            echo "::error::Tag-based production release is temporarily disabled. Use branch push (develop/main) or workflow_dispatch for internal/closed."
            exit 1
          elif [[ "$event_name" == "workflow_dispatch" ]]; then
            track="${{ github.event.inputs.target_track }}"
            environment="mobile-${track}"
            if [[ "$track" == "closed" ]]; then
              play_track="alpha"
              requires_build="false"
              manual_source_commit="${{ github.event.inputs.source_commit }}"
              if [[ -n "$manual_source_commit" ]]; then
                source_commit="$manual_source_commit"
              else
                echo "::error::closed promotion requires source_commit input (latest successful develop internal commit SHA)."
                exit 1
              fi
            elif [[ "$track" == "internal" ]]; then
              play_track="internal"
            else
              echo "::error::Unsupported workflow_dispatch track '$track'. Allowed: internal, closed."
              exit 1
            fi
          else
            echo "::error::Unsupported trigger '$event_name'."
            exit 1
          fi

          if [[ ! "$source_commit" =~ ^[0-9a-f]{40}$ ]]; then
            echo "::error::Invalid source_commit '$source_commit'. Expected full 40-char SHA."
            exit 1
          fi

          artifact_name="agrinova-android-aab-${source_commit}"

          pubspec_version_line="$(grep -E '^version:' apps/mobile/pubspec.yaml | head -n1 || true)"
          pubspec_version="$(echo "$pubspec_version_line" | awk '{print $2}')"
          base_version="${pubspec_version%%+*}"

          if [[ ! "$base_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Cannot parse base semantic version from apps/mobile/pubspec.yaml (found '$pubspec_version')."
            exit 1
          fi

          if [[ "$requires_build" == "true" ]]; then
            if [[ -z "$version_name" ]]; then
              manual_version_name="${{ github.event.inputs.version_name }}"
              if [[ "$event_name" == "workflow_dispatch" && -n "$manual_version_name" ]]; then
                version_name="$manual_version_name"
              elif [[ "$track" == "internal" ]]; then
                version_name="${base_version}-dev.${GITHUB_RUN_NUMBER}"
              elif [[ "$track" == "closed" ]]; then
                version_name="${base_version}-rc.${GITHUB_RUN_NUMBER}"
              else
                version_name="$base_version"
              fi
            fi

            manual_version_code="${{ github.event.inputs.version_code }}"
            if [[ -n "$manual_version_code" ]]; then
              version_code="$manual_version_code"
            else
              version_code="$(date +%s)"
            fi

            if [[ ! "$version_code" =~ ^[0-9]+$ ]]; then
              echo "::error::versionCode must be a positive integer (got '$version_code')."
              exit 1
            fi

            if (( version_code <= 0 )); then
              echo "::error::versionCode must be greater than zero."
              exit 1
            fi

            if (( version_code > ANDROID_MAX_VERSION_CODE )); then
              echo "::error::versionCode exceeds Android max (${ANDROID_MAX_VERSION_CODE})."
              exit 1
            fi

            if [[ "$is_production" == "true" && ! "$version_name" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "::error::Production versionName must be semantic (X.Y.Z)."
              exit 1
            fi
          else
            version_name="from-artifact"
            version_code="from-artifact"
          fi

          echo "track=$track" >> "$GITHUB_OUTPUT"
          echo "play_track=$play_track" >> "$GITHUB_OUTPUT"
          echo "environment=$environment" >> "$GITHUB_OUTPUT"
          echo "is_production=$is_production" >> "$GITHUB_OUTPUT"
          echo "requires_build=$requires_build" >> "$GITHUB_OUTPUT"
          echo "source_commit=$source_commit" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$artifact_name" >> "$GITHUB_OUTPUT"
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "version_code=$version_code" >> "$GITHUB_OUTPUT"

          echo "Release plan:"
          echo "  event       = $event_name"
          echo "  ref         = $ref_type/$ref_name"
          echo "  track       = $track"
          echo "  play_track  = $play_track"
          echo "  environment = $environment"
          echo "  production  = $is_production"
          echo "  build       = $requires_build"
          echo "  source      = $source_commit"
          echo "  artifact    = $artifact_name"
          echo "  versionName = $version_name"
          echo "  versionCode = $version_code"

  validate:
    name: Validate Flutter (analyze + test)
    runs-on: ubuntu-latest
    needs: plan
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze

      - name: Run smoke tests
        working-directory: apps/mobile
        run: flutter test test/widget_test.dart

  build-and-deploy:
    name: Build and Deploy to Google Play
    if: needs.plan.outputs.requires_build == 'true'
    runs-on: ubuntu-latest
    needs: [plan, validate]
    timeout-minutes: 50
    environment:
      name: ${{ needs.plan.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Write google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        working-directory: apps/mobile/android/app
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "$GOOGLE_SERVICES_JSON" ]]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > google-services.json
            echo "google-services.json written from secret."
          fi
          if [[ ! -f google-services.json ]]; then
            echo "::error::google-services.json missing. Commit file or set GOOGLE_SERVICES_JSON_BASE64."
            exit 1
          fi

      - name: Write keystore and key.properties
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        working-directory: apps/mobile/android
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_B64" | base64 --decode > app/release.keystore
          printf 'storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=%s\n' \
            "$STORE_PASSWORD" \
            "$KEY_PASSWORD" \
            "$KEY_ALIAS" \
            "release.keystore" \
            > key.properties

      - name: Verify versionCode is higher than Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
          VERSION_CODE: ${{ needs.plan.outputs.version_code }}
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --quiet --upgrade google-api-python-client google-auth
          python - <<'PY'
          import json
          import os
          import sys
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.errors import HttpError

          package_name = os.environ["ANDROID_PACKAGE_NAME"]
          version_code = int(os.environ["VERSION_CODE"])
          service_account_info = json.loads(os.environ["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"])
          scopes = ["https://www.googleapis.com/auth/androidpublisher"]
          creds = service_account.Credentials.from_service_account_info(service_account_info, scopes=scopes)
          service = build("androidpublisher", "v3", credentials=creds, cache_discovery=False)

          edit = service.edits().insert(packageName=package_name, body={}).execute()
          edit_id = edit["id"]
          max_code = 0
          tracks = ["internal", "alpha", "beta", "production"]

          try:
            for track in tracks:
              try:
                resp = service.edits().tracks().get(
                  packageName=package_name,
                  editId=edit_id,
                  track=track
                ).execute()
              except HttpError as err:
                status = getattr(err.resp, "status", None)
                if status == 404:
                  continue
                raise

              for release in resp.get("releases", []):
                for code in release.get("versionCodes", []):
                  max_code = max(max_code, int(code))
          finally:
            try:
              service.edits().delete(packageName=package_name, editId=edit_id).execute()
            except Exception:
              pass

          if max_code and version_code <= max_code:
            print(f"::error::versionCode {version_code} must be greater than current Play max {max_code}.")
            sys.exit(1)

          print(f"versionCode check passed: {version_code} > {max_code}")
          PY

      - name: Install Flutter dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Build release AAB
        working-directory: apps/mobile
        run: |
          flutter build appbundle \
            --release \
            --build-name=${{ needs.plan.outputs.version_name }} \
            --build-number=${{ needs.plan.outputs.version_code }} \
            --dart-define-from-file=env/prod.json

      - name: Prepare release notes
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          WHATSNEW_DIR="$(mktemp -d)/whatsnew"
          mkdir -p "$WHATSNEW_DIR"

          VERSION_NAME="${{ needs.plan.outputs.version_name }}"
          TRACK_NAME="${{ needs.plan.outputs.track }}"
          NOTES_ID_TMP="$(mktemp)"
          NOTES_EN_TMP="$(mktemp)"
          COMMITS_FILE="$(mktemp)"

          current_tag=""
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            current_tag="${{ github.ref_name }}"
          fi

          previous_tag=""
          while IFS= read -r tag; do
            [[ -z "$tag" ]] && continue
            if [[ -n "$current_tag" && "$tag" == "$current_tag" ]]; then
              continue
            fi
            previous_tag="$tag"
            break
          done < <(git tag --list 'mobile/v*.*.*' --sort=-version:refname)

          if [[ -n "$previous_tag" ]]; then
            git log --no-merges --format='%s' "${previous_tag}..HEAD" > "$COMMITS_FILE" || true
          else
            git log --no-merges -n 30 --format='%s' > "$COMMITS_FILE" || true
          fi

          echo "Versi ${VERSION_NAME}:" > "$NOTES_ID_TMP"
          echo "Version ${VERSION_NAME}:" > "$NOTES_EN_TMP"

          changes_count=0
          while IFS= read -r subject; do
            [[ -z "$subject" ]] && continue
            [[ "$subject" =~ ^Merge[[:space:]] ]] && continue

            commit_type="other"
            commit_desc="$subject"
            if [[ "$subject" == *:* ]]; then
              prefix="${subject%%:*}"
              rest="${subject#*:}"
              commit_desc="${rest# }"
              commit_type="${prefix%%(*}"
              commit_type="${commit_type%!}"
              commit_type="${commit_type,,}"
              if [[ -z "$commit_desc" ]]; then
                commit_desc="$subject"
              fi
            fi

            label_id="Perubahan"
            label_en="Change"
            case "$commit_type" in
              fix)
                label_id="Perbaikan"
                label_en="Fix"
                ;;
              feat)
                label_id="Fitur"
                label_en="Feature"
                ;;
              perf)
                label_id="Performa"
                label_en="Performance"
                ;;
              refactor)
                label_id="Refactor"
                label_en="Refactor"
                ;;
              build|ci|chore)
                label_id="Build/CI"
                label_en="Build/CI"
                ;;
              docs)
                label_id="Dokumentasi"
                label_en="Docs"
                ;;
              test)
                label_id="Pengujian"
                label_en="Test"
                ;;
            esac

            printf -- "- %s: %s\n" "$label_id" "$commit_desc" >> "$NOTES_ID_TMP"
            printf -- "- %s: %s\n" "$label_en" "$commit_desc" >> "$NOTES_EN_TMP"
            changes_count=$((changes_count + 1))
            if (( changes_count >= 8 )); then
              break
            fi
          done < "$COMMITS_FILE"

          if (( changes_count == 0 )); then
            echo "- Perbaikan bug dan peningkatan performa untuk track ${TRACK_NAME}." >> "$NOTES_ID_TMP"
            echo "- Bug fixes and performance improvements for ${TRACK_NAME} track." >> "$NOTES_EN_TMP"
          fi

          head -c 500 "$NOTES_ID_TMP" > "$WHATSNEW_DIR/whatsnew-id-ID"
          head -c 500 "$NOTES_EN_TMP" > "$WHATSNEW_DIR/whatsnew-en-US"

          echo "dir=$WHATSNEW_DIR" >> "$GITHUB_OUTPUT"

      - name: Package promotion artifact
        shell: bash
        run: |
          set -euo pipefail
          DIST_DIR="$RUNNER_TEMP/promotion"
          mkdir -p "$DIST_DIR/whatsnew"

          cp apps/mobile/build/app/outputs/bundle/release/app-release.aab "$DIST_DIR/app-release.aab"
          cp -R "${{ steps.notes.outputs.dir }}/." "$DIST_DIR/whatsnew/"

          if [[ -f apps/mobile/build/app/outputs/mapping/release/mapping.txt ]]; then
            cp apps/mobile/build/app/outputs/mapping/release/mapping.txt "$DIST_DIR/mapping.txt"
          fi

          AAB_SHA256="$(sha256sum "$DIST_DIR/app-release.aab" | awk '{print $1}')"
          cat > "$DIST_DIR/release-metadata.json" <<EOF
          {
            "source_commit": "${{ needs.plan.outputs.source_commit }}",
            "version_name": "${{ needs.plan.outputs.version_name }}",
            "version_code": "${{ needs.plan.outputs.version_code }}",
            "track": "${{ needs.plan.outputs.track }}",
            "play_track": "${{ needs.plan.outputs.play_track }}",
            "aab_sha256": "$AAB_SHA256",
            "build_run_id": "${{ github.run_id }}",
            "build_run_number": "${{ github.run_number }}"
          }
          EOF

      - name: Upload promotion artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.plan.outputs.artifact_name }}
          path: ${{ runner.temp }}/promotion/**
          retention-days: 30

      - name: Deploy to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: apps/mobile/build/app/outputs/bundle/release/app-release.aab
          track: ${{ needs.plan.outputs.play_track }}
          status: completed
          mappingFile: apps/mobile/build/app/outputs/mapping/release/mapping.txt
          whatsNewDirectory: ${{ steps.notes.outputs.dir }}

      - name: Write job summary
        if: success()
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## Android Release Deployed

          | Field | Value |
          |-------|-------|
          | **Version** | ${{ needs.plan.outputs.version_name }}+${{ needs.plan.outputs.version_code }} |
          | **Ref** | `${{ github.ref_name }}` |
          | **Track** | `${{ needs.plan.outputs.track }}` |
          | **Play Track** | `${{ needs.plan.outputs.play_track }}` |
          | **Environment** | `${{ needs.plan.outputs.environment }}` |
          | **Source Commit** | `${{ needs.plan.outputs.source_commit }}` |
          | **Promotion Artifact** | `${{ needs.plan.outputs.artifact_name }}` |
          | **Package** | `${{ secrets.ANDROID_PACKAGE_NAME }}` |
          | **Commit** | `${{ github.sha }}` |
          | **Run** | `#${{ github.run_number }}` |
          EOF

      - name: Clean up signing files
        if: always()
        run: |
          rm -f apps/mobile/android/app/release.keystore
          rm -f apps/mobile/android/key.properties
          rm -f apps/mobile/android/app/google-services.json

  promote-to-alpha:
    name: Promote Existing AAB to Alpha
    if: needs.plan.outputs.requires_build == 'false' && needs.plan.outputs.track == 'closed'
    runs-on: ubuntu-latest
    needs: [plan, validate]
    timeout-minutes: 30
    environment:
      name: ${{ needs.plan.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find develop run artifact for source commit
        id: find_artifact
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sourceCommit = '${{ needs.plan.outputs.source_commit }}';
            const artifactName = '${{ needs.plan.outputs.artifact_name }}';
            const workflowPath = '.github/workflows/android-release.yml';

            const runs = await github.paginate(
              github.rest.actions.listWorkflowRunsForRepo,
              {
                owner,
                repo,
                branch: 'develop',
                event: 'push',
                status: 'success',
                per_page: 100
              }
            );
            const developRuns = runs
              .filter((run) => typeof run.path === 'string' && run.path.startsWith(workflowPath))
              .sort((a, b) => b.id - a.id);

            let latestPromotable = null;

            for (const run of developRuns) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: run.id,
                per_page: 100
              });

              const expectedArtifactName = `agrinova-android-aab-${run.head_sha}`;
              const match = artifacts.data.artifacts.find(
                (artifact) => artifact.name === expectedArtifactName && !artifact.expired
              );

              if (match) {
                latestPromotable = {
                  run,
                  artifact: match,
                  expectedArtifactName,
                };
                break;
              }
            }

            if (!latestPromotable) {
              core.setFailed('No promotable develop internal artifact found (artifact missing or expired).');
              return;
            }

            core.setOutput('latest_source_commit', latestPromotable.run.head_sha);

            if (sourceCommit !== latestPromotable.run.head_sha) {
              core.setFailed(
                `source_commit must match latest successful develop internal artifact commit. ` +
                `Expected ${latestPromotable.run.head_sha}, got ${sourceCommit}.`
              );
              return;
            }

            if (artifactName !== latestPromotable.expectedArtifactName) {
              core.setFailed(
                `Artifact name mismatch. Expected ${latestPromotable.expectedArtifactName}, got ${artifactName}.`
              );
              return;
            }

            core.info(`Using latest promotable run ${latestPromotable.run.id} for commit ${sourceCommit}.`);
            core.setOutput('run_id', String(latestPromotable.run.id));
            core.setOutput('artifact_id', String(latestPromotable.artifact.id));

      - name: Download promotion artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.plan.outputs.artifact_name }}
          run-id: ${{ steps.find_artifact.outputs.run_id }}
          github-token: ${{ github.token }}
          path: ${{ runner.temp }}/promotion

      - name: Validate artifact metadata
        id: metadata
        shell: bash
        run: |
          set -euo pipefail

          ART_DIR="${{ runner.temp }}/promotion"
          META_FILE="$(find "$ART_DIR" -type f -name 'release-metadata.json' | head -n1 || true)"
          AAB_FILE="$(find "$ART_DIR" -type f -name 'app-release.aab' | head -n1 || true)"
          NOTES_DIR="$(find "$ART_DIR" -type d -name 'whatsnew' | head -n1 || true)"

          [[ -n "$META_FILE" && -f "$META_FILE" ]] || { echo "::error::Missing release-metadata.json in artifact."; exit 1; }
          [[ -n "$AAB_FILE" && -f "$AAB_FILE" ]] || { echo "::error::Missing app-release.aab in artifact."; exit 1; }

          python - "$META_FILE" "$AAB_FILE" <<'PY' > "$RUNNER_TEMP/meta.env"
          import hashlib
          import json
          import sys
          from pathlib import Path

          meta = json.loads(Path(sys.argv[1]).read_text(encoding="utf-8"))
          aab_path = Path(sys.argv[2])
          aab_sha256 = hashlib.sha256(aab_path.read_bytes()).hexdigest()
          expected_sha256 = meta.get("aab_sha256", "")
          if expected_sha256 and expected_sha256 != aab_sha256:
            print("error=sha256-mismatch")
            sys.exit(2)

          required = ["source_commit", "version_name", "version_code"]
          for key in required:
            if not meta.get(key):
              print(f"error=missing-{key}")
              sys.exit(3)

          print(f"meta_source_commit={meta['source_commit']}")
          print(f"meta_version_name={meta['version_name']}")
          print(f"meta_version_code={meta['version_code']}")
          print(f"meta_aab_sha256={aab_sha256}")
          PY

          source "$RUNNER_TEMP/meta.env"
          if [[ "${meta_source_commit}" != "${{ needs.plan.outputs.source_commit }}" ]]; then
            echo "::error::Artifact source_commit ${meta_source_commit} does not match expected ${{ needs.plan.outputs.source_commit }}."
            exit 1
          fi

          echo "version_name=${meta_version_name}" >> "$GITHUB_OUTPUT"
          echo "version_code=${meta_version_code}" >> "$GITHUB_OUTPUT"
          echo "aab_sha256=${meta_aab_sha256}" >> "$GITHUB_OUTPUT"
          echo "aab_file=${AAB_FILE}" >> "$GITHUB_OUTPUT"
          if [[ -n "$NOTES_DIR" ]]; then
            echo "notes_dir=${NOTES_DIR}" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure release notes exists
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          NOTES_DIR="${{ steps.metadata.outputs.notes_dir }}"
          if [[ -z "$NOTES_DIR" ]]; then
            NOTES_DIR="${{ runner.temp }}/promotion/whatsnew"
          fi
          mkdir -p "$NOTES_DIR"

          if [[ ! -f "$NOTES_DIR/whatsnew-id-ID" ]]; then
            echo "Perbaikan bug dan peningkatan performa untuk versi ${{ steps.metadata.outputs.version_name }}." > "$NOTES_DIR/whatsnew-id-ID"
          fi

          if [[ ! -f "$NOTES_DIR/whatsnew-en-US" ]]; then
            echo "Bug fixes and performance improvements for version ${{ steps.metadata.outputs.version_name }}." > "$NOTES_DIR/whatsnew-en-US"
          fi

          echo "dir=${NOTES_DIR}" >> "$GITHUB_OUTPUT"

      - name: Deploy to Google Play (alpha)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: ${{ steps.metadata.outputs.aab_file }}
          track: ${{ needs.plan.outputs.play_track }}
          status: completed
          whatsNewDirectory: ${{ steps.notes.outputs.dir }}

      - name: Write job summary
        if: success()
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## Android Promotion Deployed

          | Field | Value |
          |-------|-------|
          | **Version** | ${{ steps.metadata.outputs.version_name }}+${{ steps.metadata.outputs.version_code }} |
          | **Ref** | `${{ github.ref_name }}` |
          | **Track** | `${{ needs.plan.outputs.track }}` |
          | **Play Track** | `${{ needs.plan.outputs.play_track }}` |
          | **Environment** | `${{ needs.plan.outputs.environment }}` |
          | **Source Commit** | `${{ needs.plan.outputs.source_commit }}` |
          | **AAB SHA256** | `${{ steps.metadata.outputs.aab_sha256 }}` |
          | **Promotion Artifact** | `${{ needs.plan.outputs.artifact_name }}` |
          | **Artifact Run ID** | `${{ steps.find_artifact.outputs.run_id }}` |
          | **Package** | `${{ secrets.ANDROID_PACKAGE_NAME }}` |
          | **Commit** | `${{ github.sha }}` |
          | **Run** | `#${{ github.run_number }}` |
          EOF
