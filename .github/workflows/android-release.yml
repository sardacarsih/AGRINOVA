name: Android Release

on:
  push:
    branches:
      - develop
      - main
      - 'release/**'
    tags:
      - 'v*.*.*'
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/android-release.yml'
  workflow_dispatch:
    inputs:
      target_track:
        description: 'Manual run target track (non-production only)'
        type: choice
        required: true
        default: internal
        options:
          - internal
          - closed
      version_name:
        description: 'Optional Android versionName override'
        required: false
        default: ''
      version_code:
        description: 'Optional Android versionCode override'
        required: false
        default: ''

permissions:
  contents: read

concurrency:
  group: android-release-mobile
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.38.9'
  JAVA_VERSION: '17'
  ANDROID_MAX_VERSION_CODE: '2100000000'

jobs:
  plan:
    name: Plan Release Track and Version
    runs-on: ubuntu-latest
    outputs:
      track: ${{ steps.plan.outputs.track }}
      environment: ${{ steps.plan.outputs.environment }}
      is_production: ${{ steps.plan.outputs.is_production }}
      version_name: ${{ steps.plan.outputs.version_name }}
      version_code: ${{ steps.plan.outputs.version_code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve track and version
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          event_name="${{ github.event_name }}"
          ref_type="${{ github.ref_type }}"
          ref_name="${{ github.ref_name }}"

          track=""
          environment=""
          is_production="false"
          version_name=""

          if [[ "$event_name" == "push" && "$ref_type" == "tag" ]]; then
            if [[ "$ref_name" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              track="production"
              environment="mobile-production"
              is_production="true"
              version_name="${ref_name#v}"
            else
              echo "::error::Production release must use semantic tag format vX.Y.Z (example: v1.2.3)."
              exit 1
            fi
          elif [[ "$event_name" == "push" && "$ref_type" == "branch" ]]; then
            if [[ "$ref_name" == "develop" ]]; then
              track="internal"
              environment="mobile-internal"
            elif [[ "$ref_name" == "main" || "$ref_name" == release/* ]]; then
              track="closed"
              environment="mobile-closed"
            else
              echo "::error::Unsupported branch '$ref_name'. Allowed: develop, main, release/*."
              exit 1
            fi
          elif [[ "$event_name" == "workflow_dispatch" ]]; then
            track="${{ github.event.inputs.target_track }}"
            environment="mobile-${track}"
          else
            echo "::error::Unsupported trigger '$event_name'."
            exit 1
          fi

          pubspec_version_line="$(grep -E '^version:' apps/mobile/pubspec.yaml | head -n1 || true)"
          pubspec_version="$(echo "$pubspec_version_line" | awk '{print $2}')"
          base_version="${pubspec_version%%+*}"

          if [[ ! "$base_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Cannot parse base semantic version from apps/mobile/pubspec.yaml (found '$pubspec_version')."
            exit 1
          fi

          if [[ -z "$version_name" ]]; then
            manual_version_name="${{ github.event.inputs.version_name }}"
            if [[ "$event_name" == "workflow_dispatch" && -n "$manual_version_name" ]]; then
              version_name="$manual_version_name"
            elif [[ "$track" == "internal" ]]; then
              version_name="${base_version}-dev.${GITHUB_RUN_NUMBER}"
            elif [[ "$track" == "closed" ]]; then
              version_name="${base_version}-rc.${GITHUB_RUN_NUMBER}"
            else
              version_name="$base_version"
            fi
          fi

          manual_version_code="${{ github.event.inputs.version_code }}"
          if [[ -n "$manual_version_code" ]]; then
            version_code="$manual_version_code"
          else
            version_code="$(date +%s)"
          fi

          if [[ ! "$version_code" =~ ^[0-9]+$ ]]; then
            echo "::error::versionCode must be a positive integer (got '$version_code')."
            exit 1
          fi

          if (( version_code <= 0 )); then
            echo "::error::versionCode must be greater than zero."
            exit 1
          fi

          if (( version_code > ANDROID_MAX_VERSION_CODE )); then
            echo "::error::versionCode exceeds Android max (${ANDROID_MAX_VERSION_CODE})."
            exit 1
          fi

          if [[ "$is_production" == "true" && ! "$version_name" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Production versionName must be semantic (X.Y.Z)."
            exit 1
          fi

          echo "track=$track" >> "$GITHUB_OUTPUT"
          echo "environment=$environment" >> "$GITHUB_OUTPUT"
          echo "is_production=$is_production" >> "$GITHUB_OUTPUT"
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"
          echo "version_code=$version_code" >> "$GITHUB_OUTPUT"

          echo "Release plan:"
          echo "  event       = $event_name"
          echo "  ref         = $ref_type/$ref_name"
          echo "  track       = $track"
          echo "  environment = $environment"
          echo "  production  = $is_production"
          echo "  versionName = $version_name"
          echo "  versionCode = $version_code"

  validate:
    name: Validate Flutter (analyze + test)
    runs-on: ubuntu-latest
    needs: plan
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Analyze
        working-directory: apps/mobile
        run: flutter analyze

      - name: Run smoke tests
        working-directory: apps/mobile
        run: flutter test test/widget_test.dart

  build-and-deploy:
    name: Build and Deploy to Google Play
    runs-on: ubuntu-latest
    needs: [plan, validate]
    timeout-minutes: 50
    environment:
      name: ${{ needs.plan.outputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Write google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        working-directory: apps/mobile/android/app
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "$GOOGLE_SERVICES_JSON" ]]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > google-services.json
            echo "google-services.json written from secret."
          fi
          if [[ ! -f google-services.json ]]; then
            echo "::error::google-services.json missing. Commit file or set GOOGLE_SERVICES_JSON_BASE64."
            exit 1
          fi

      - name: Write keystore and key.properties
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        working-directory: apps/mobile/android
        shell: bash
        run: |
          set -euo pipefail
          echo "$KEYSTORE_B64" | base64 --decode > app/release.keystore
          printf 'storePassword=%s\nkeyPassword=%s\nkeyAlias=%s\nstoreFile=%s\n' \
            "$STORE_PASSWORD" \
            "$KEY_PASSWORD" \
            "$KEY_ALIAS" \
            "release.keystore" \
            > key.properties

      - name: Verify versionCode is higher than Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          ANDROID_PACKAGE_NAME: ${{ secrets.ANDROID_PACKAGE_NAME }}
          VERSION_CODE: ${{ needs.plan.outputs.version_code }}
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --quiet --upgrade google-api-python-client google-auth
          python - <<'PY'
          import json
          import os
          import sys
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.errors import HttpError

          package_name = os.environ["ANDROID_PACKAGE_NAME"]
          version_code = int(os.environ["VERSION_CODE"])
          service_account_info = json.loads(os.environ["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON"])
          scopes = ["https://www.googleapis.com/auth/androidpublisher"]
          creds = service_account.Credentials.from_service_account_info(service_account_info, scopes=scopes)
          service = build("androidpublisher", "v3", credentials=creds, cache_discovery=False)

          edit = service.edits().insert(packageName=package_name, body={}).execute()
          edit_id = edit["id"]
          max_code = 0
          tracks = ["internal", "alpha", "beta", "closed", "production"]

          try:
            for track in tracks:
              try:
                resp = service.edits().tracks().get(
                  packageName=package_name,
                  editId=edit_id,
                  track=track
                ).execute()
              except HttpError as err:
                status = getattr(err.resp, "status", None)
                if status == 404:
                  continue
                raise

              for release in resp.get("releases", []):
                for code in release.get("versionCodes", []):
                  max_code = max(max_code, int(code))
          finally:
            try:
              service.edits().delete(packageName=package_name, editId=edit_id).execute()
            except Exception:
              pass

          if max_code and version_code <= max_code:
            print(f"::error::versionCode {version_code} must be greater than current Play max {max_code}.")
            sys.exit(1)

          print(f"versionCode check passed: {version_code} > {max_code}")
          PY

      - name: Install Flutter dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Build release AAB
        working-directory: apps/mobile
        run: |
          flutter build appbundle \
            --release \
            --build-name=${{ needs.plan.outputs.version_name }} \
            --build-number=${{ needs.plan.outputs.version_code }} \
            --dart-define-from-file=env/prod.json

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: agrinova-android-${{ needs.plan.outputs.version_name }}-${{ needs.plan.outputs.version_code }}
          path: apps/mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Prepare release notes
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          WHATSNEW_DIR="$(mktemp -d)/whatsnew"
          mkdir -p "$WHATSNEW_DIR"

          STATIC_ID="apps/mobile/whatsnew/whatsnew-id-ID"
          STATIC_ID_LEGACY="apps/mobile/whatsnew/whatsnew-id"
          STATIC_EN="apps/mobile/whatsnew/whatsnew-en-US"

          if [[ -f "$STATIC_ID" ]]; then
            cp "$STATIC_ID" "$WHATSNEW_DIR/whatsnew-id-ID"
          elif [[ -f "$STATIC_ID_LEGACY" ]]; then
            cp "$STATIC_ID_LEGACY" "$WHATSNEW_DIR/whatsnew-id-ID"
          else
            TAG_BODY=""
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              TAG_BODY="$(git tag -l --format='%(contents:body)' "${{ github.ref_name }}" 2>/dev/null || true)"
              if [[ -z "$TAG_BODY" ]]; then
                TAG_BODY="$(git tag -l --format='%(contents:subject)' "${{ github.ref_name }}" 2>/dev/null || true)"
              fi
            fi

            if [[ -n "$TAG_BODY" ]]; then
              echo "$TAG_BODY" | head -c 500 > "$WHATSNEW_DIR/whatsnew-id-ID"
            else
              echo "Perbaikan bug dan peningkatan performa track ${{ needs.plan.outputs.track }} untuk versi ${{ needs.plan.outputs.version_name }}." \
                > "$WHATSNEW_DIR/whatsnew-id-ID"
            fi
          fi

          if [[ -f "$STATIC_EN" ]]; then
            cp "$STATIC_EN" "$WHATSNEW_DIR/whatsnew-en-US"
          else
            echo "Bug fixes and performance improvements for version ${{ needs.plan.outputs.version_name }}." \
              > "$WHATSNEW_DIR/whatsnew-en-US"
          fi

          echo "dir=$WHATSNEW_DIR" >> "$GITHUB_OUTPUT"

      - name: Deploy to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: apps/mobile/build/app/outputs/bundle/release/app-release.aab
          track: ${{ needs.plan.outputs.track }}
          status: completed
          mappingFile: apps/mobile/build/app/outputs/mapping/release/mapping.txt
          whatsNewDirectory: ${{ steps.notes.outputs.dir }}

      - name: Write job summary
        if: success()
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## Android Release Deployed

          | Field | Value |
          |-------|-------|
          | **Version** | ${{ needs.plan.outputs.version_name }}+${{ needs.plan.outputs.version_code }} |
          | **Ref** | `${{ github.ref_name }}` |
          | **Track** | `${{ needs.plan.outputs.track }}` |
          | **Environment** | `${{ needs.plan.outputs.environment }}` |
          | **Package** | `${{ secrets.ANDROID_PACKAGE_NAME }}` |
          | **Commit** | `${{ github.sha }}` |
          | **Run** | `#${{ github.run_number }}` |
          EOF

      - name: Clean up signing files
        if: always()
        run: |
          rm -f apps/mobile/android/app/release.keystore
          rm -f apps/mobile/android/key.properties
          rm -f apps/mobile/android/app/google-services.json
