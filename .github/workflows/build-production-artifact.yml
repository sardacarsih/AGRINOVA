name: Build Production Artifact

on:
  workflow_run:
    workflows:
      - Go and Next CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: build-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-production:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push') }}
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      SOURCE_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
      SOURCE_BRANCH: ${{ github.event.workflow_run.head_branch || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_SHA }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: apps/golang/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: apps/web/package-lock.json

      - name: Build backend runtime artifact
        shell: pwsh
        working-directory: apps/golang
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\package-binaries.ps1 -TargetOS windows -TargetArch amd64 -ReleaseName backend-windows-amd64 -SkipSeed -SkipEnvTemplate

          if (!(Test-Path ".\release\backend-windows-amd64\agrinova-migrate.exe")) {
            throw "Missing agrinova-migrate.exe in backend release."
          }

          if (!(Test-Path ".\release\backend-windows-amd64\agrinova-server.exe")) {
            throw "Missing agrinova-server.exe in backend release."
          }

          if (Test-Path ".\release\backend-windows-amd64\agrinova-seed.exe") {
            throw "agrinova-seed.exe must not be included in production bundle."
          }

          if (Test-Path ".\release\backend-windows-amd64\.env.example") {
            throw ".env.example must not be included in production bundle."
          }

      - name: Build web standalone runtime artifact
        shell: pwsh
        working-directory: apps/web
        run: |
          npm ci
          npm run build:standalone
          powershell -ExecutionPolicy Bypass -File .\scripts\package-standalone.ps1 -ReleaseName web-standalone

          if (!(Test-Path ".\release\web-standalone\server.js") -and !(Test-Path ".\release\web-standalone\apps\web\server.js")) {
            throw "Missing server.js in web release."
          }

      - name: Assemble production bundle
        shell: pwsh
        run: |
          $dist = "dist"
          Remove-Item -Path $dist -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "$dist\backend" -Force | Out-Null
          New-Item -ItemType Directory -Path "$dist\web" -Force | Out-Null

          Copy-Item -Path "apps\golang\release\backend-windows-amd64\*" -Destination "$dist\backend" -Recurse -Force
          Copy-Item -Path "apps\web\release\web-standalone\*" -Destination "$dist\web" -Recurse -Force

          $version = "${{ github.run_number }}-${{ env.SOURCE_SHA }}"
          Set-Content -Path "$dist\VERSION.txt" -Value $version -Encoding ASCII

          $manifest = @{
            repository = "${{ github.repository }}"
            workflow = "${{ github.workflow }}"
            run_id = "${{ github.run_id }}"
            run_number = "${{ github.run_number }}"
            run_attempt = "${{ github.run_attempt }}"
            branch = "${{ env.SOURCE_BRANCH }}"
            commit_sha = "${{ env.SOURCE_SHA }}"
            created_utc = (Get-Date).ToUniversalTime().ToString("o")
          } | ConvertTo-Json -Depth 5
          Set-Content -Path "$dist\MANIFEST.json" -Value $manifest -Encoding UTF8

      - name: Generate release notes
        shell: pwsh
        run: |
          $dist = "dist"
          $releaseNotesFile = "RELEASE_NOTES.md"
          $sha = "${{ env.SOURCE_SHA }}"
          $branch = "${{ env.SOURCE_BRANCH }}"
          $repo = "${{ github.repository }}"

          $shortSha = (git rev-parse --short $sha).Trim()
          $subject = (git show -s --format=%s $sha).Trim()
          $author = (git show -s --format=%an $sha).Trim()
          $commitDate = (git show -s --format=%cI $sha).Trim()
          $generatedUtc = (Get-Date).ToUniversalTime().ToString("o")

          $changedFiles = @(git diff-tree --no-commit-id --name-only -r $sha)

          $backendFiles = @()
          $webFiles = @()
          $mobileFiles = @()
          $ciFiles = @()
          $otherFiles = @()

          foreach ($file in $changedFiles) {
            if ($file -like "apps/golang/*") {
              $backendFiles += $file
            } elseif ($file -like "apps/web/*") {
              $webFiles += $file
            } elseif ($file -like "apps/mobile/*") {
              $mobileFiles += $file
            } elseif ($file -like ".github/workflows/*" -or $file -like "scripts/windows-production/*") {
              $ciFiles += $file
            } else {
              $otherFiles += $file
            }
          }

          function Format-Section {
            param(
              [string]$Title,
              [array]$Items
            )
            if ($Items.Count -eq 0) {
              return @(
                "### $Title",
                "- None",
                ""
              )
            }

            $content = @("### $Title")
            foreach ($item in $Items) {
              $content += "- $item"
            }
            $content += ""
            return $content
          }

          $notes = @()
          $notes += "# Release Notes"
          $notes += ""
          $notes += "Generated UTC: $generatedUtc"
          $notes += ""
          $notes += "## Release Metadata"
          $notes += "- Repository: $repo"
          $notes += "- Branch: $branch"
          $notes += "- Commit: $sha ($shortSha)"
          $notes += "- Summary: $subject"
          $notes += "- Author: $author"
          $notes += "- Commit Date: $commitDate"
          $notes += ""
          $notes += "## Changed Files By Area"
          $notes += ""
          $notes += Format-Section -Title "Backend (apps/golang)" -Items $backendFiles
          $notes += Format-Section -Title "Web (apps/web)" -Items $webFiles
          $notes += Format-Section -Title "Mobile (apps/mobile)" -Items $mobileFiles
          $notes += Format-Section -Title "CI/CD (.github/workflows, scripts/windows-production)" -Items $ciFiles
          $notes += Format-Section -Title "Other" -Items $otherFiles
          $notes += "## Recent Commits (main)"
          $notes += ""

          $recentCommits = @(git log --pretty=format:"- %h %s" -n 10)
          if ($recentCommits.Count -eq 0) {
            $notes += "- None"
          } else {
            $notes += $recentCommits
          }
          $notes += ""

          Set-Content -Path $releaseNotesFile -Value $notes -Encoding UTF8
          Copy-Item -Path $releaseNotesFile -Destination "$dist\RELEASE_NOTES.md" -Force

      - name: Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: agrinova-production-bundle
          path: dist
          include-hidden-files: true
          retention-days: 30
