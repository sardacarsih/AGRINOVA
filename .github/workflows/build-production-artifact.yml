name: Build Production Artifact

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build-production:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest
    env:
      SOURCE_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
      SOURCE_BRANCH: ${{ github.event.workflow_run.head_branch || github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_SHA }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: apps/golang/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: apps/web/package-lock.json

      - name: Build backend runtime artifact
        shell: pwsh
        working-directory: apps/golang
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\package-binaries.ps1 -TargetOS windows -TargetArch amd64 -ReleaseName backend-windows-amd64 -SkipSeed -SkipEnvTemplate

          if (!(Test-Path ".\release\backend-windows-amd64\agrinova-migrate.exe")) {
            throw "Missing agrinova-migrate.exe in backend release."
          }

          if (!(Test-Path ".\release\backend-windows-amd64\agrinova-server.exe")) {
            throw "Missing agrinova-server.exe in backend release."
          }

          if (Test-Path ".\release\backend-windows-amd64\agrinova-seed.exe") {
            throw "agrinova-seed.exe must not be included in production bundle."
          }

          if (Test-Path ".\release\backend-windows-amd64\.env.example") {
            throw ".env.example must not be included in production bundle."
          }

      - name: Build web standalone runtime artifact
        shell: pwsh
        working-directory: apps/web
        run: |
          npm ci
          npm run build:standalone
          powershell -ExecutionPolicy Bypass -File .\scripts\package-standalone.ps1 -ReleaseName web-standalone

          if (!(Test-Path ".\release\web-standalone\server.js") -and !(Test-Path ".\release\web-standalone\apps\web\server.js")) {
            throw "Missing server.js in web release."
          }

      - name: Assemble production bundle
        shell: pwsh
        run: |
          $dist = "dist"
          Remove-Item -Path $dist -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "$dist\backend" -Force | Out-Null
          New-Item -ItemType Directory -Path "$dist\web" -Force | Out-Null

          Copy-Item -Path "apps\golang\release\backend-windows-amd64\*" -Destination "$dist\backend" -Recurse -Force
          Copy-Item -Path "apps\web\release\web-standalone\*" -Destination "$dist\web" -Recurse -Force

          $version = "${{ github.run_number }}-${{ env.SOURCE_SHA }}"
          Set-Content -Path "$dist\VERSION.txt" -Value $version -Encoding ASCII

          $manifest = @{
            repository = "${{ github.repository }}"
            workflow = "${{ github.workflow }}"
            run_id = "${{ github.run_id }}"
            run_number = "${{ github.run_number }}"
            run_attempt = "${{ github.run_attempt }}"
            branch = "${{ env.SOURCE_BRANCH }}"
            commit_sha = "${{ env.SOURCE_SHA }}"
            created_utc = (Get-Date).ToUniversalTime().ToString("o")
          } | ConvertTo-Json -Depth 5
          Set-Content -Path "$dist\MANIFEST.json" -Value $manifest -Encoding UTF8

      - name: Upload production artifact
        uses: actions/upload-artifact@v4
        with:
          name: agrinova-production-bundle
          path: dist
          include-hidden-files: true
          retention-days: 30
