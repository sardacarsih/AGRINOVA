<!DOCTYPE html>
<html>
<head>
    <title>Cookie Auth Debug Test</title>
</head>
<body>
    <h1>Cookie Authentication Debug Test</h1>
    
    <div>
        <h2>Current Cookies:</h2>
        <pre id="current-cookies"></pre>
    </div>
    
    <div>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="refreshCookies()">Refresh Cookie Display</button>
        <button onclick="testAPICall()">Test API Call</button>
    </div>
    
    <div>
        <h2>Log:</h2>
        <div id="log" style="background: #f5f5f5; padding: 10px; height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function refreshCookies() {
            const cookiesDiv = document.getElementById('current-cookies');
            const cookies = document.cookie;
            cookiesDiv.textContent = cookies || 'No cookies found';
            
            const cookieCount = cookies.split(';').filter(c => c.trim()).length;
            log(`Cookies refreshed. Found ${cookieCount} cookies: ${cookies}`);
        }

        async function testLogin() {
            log('Starting login test...');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-platform': 'WEB',
                        'User-Agent': navigator.userAgent
                    },
                    credentials: 'include', // Important for cookies
                    body: JSON.stringify({
                        username: 'superadmin',
                        password: 'demo123',
                        rememberMe: false,
                        platform: 'WEB'
                    })
                });

                log(`Login response status: ${response.status}`);
                
                const responseData = await response.json();
                log(`Login response: ${JSON.stringify(responseData, null, 2)}`);

                // Check cookies immediately after login
                setTimeout(() => {
                    refreshCookies();
                    log('Cookies checked 100ms after login response');
                }, 100);

            } catch (error) {
                log(`Login error: ${error.message}`);
            }
        }

        async function testAPICall() {
            log('Testing API call with cookies...');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/companies', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-platform': 'WEB'
                    },
                    credentials: 'include' // Include cookies
                });

                log(`API call response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`API call successful: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log(`API call failed: ${errorText}`);
                }

            } catch (error) {
                log(`API call error: ${error.message}`);
            }
        }

        // Initial cookie display
        refreshCookies();
        log('Debug test page loaded');
    </script>
</body>
</html>