<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQL Proxy Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-good { background: #28a745; }
        .status-bad { background: #dc3545; }
        .status-pending { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ GraphQL Proxy Test Dashboard</h1>

        <div class="test-section config">
            <h3>üìã Current Configuration</h3>
            <div id="config-info"></div>
        </div>

        <div class="test-section">
            <h3>üì° Proxy Connection Tests</h3>
            <button class="test-button" onclick="testProxyHealth()">Test Proxy Health</button>
            <button class="test-button" onclick="testProxyLogin()">Test Proxy Login</button>
            <button class="test-button" onclick="testProxyAuth()">Test Proxy Auth</button>
            <div id="proxy-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>üîó Direct Connection Tests</h3>
            <button class="test-button" onclick="testDirectHealth()">Test Direct Health</button>
            <button class="test-button" onclick="testDirectLogin()">Test Direct Login</button>
            <button class="test-button" onclick="testDirectAuth()">Test Direct Auth</button>
            <div id="direct-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>üîå WebSocket Connection Tests</h3>
            <button class="test-button" onclick="testWebSocket()">Test WebSocket</button>
            <div id="websocket-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>üìä Summary</h3>
            <div id="summary"></div>
        </div>
    </div>

    <script>
        // Configuration
        const PROXY_URL = '/api/graphql';
        const DIRECT_URL = 'http://localhost:8080/graphql';
        const WS_URL = 'ws://localhost:8080/graphql';

        // Test results tracking
        const results = {
            proxy: { health: null, login: null, auth: null },
            direct: { health: null, login: null, auth: null },
            websocket: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showConfiguration();
            updateSummary();
        });

        function showConfiguration() {
            const configDiv = document.getElementById('config-info');
            configDiv.innerHTML = `
                <div><strong>Proxy URL:</strong> ${PROXY_URL}</div>
                <div><strong>Direct URL:</strong> ${DIRECT_URL}</div>
                <div><strong>WebSocket URL:</strong> ${WS_URL}</div>
                <div><strong>Current Domain:</strong> ${window.location.origin}</div>
                <div><strong>User Agent:</strong> ${navigator.userAgent.substring(0, 100)}...</div>
            `;
        }

        async function makeGraphQLRequest(url, query, variables = {}, headers = {}) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify({ query, variables })
                });

                const data = await response.json();
                return { success: response.ok, data, status: response.status, headers: response.headers };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function showResults(elementId, result, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = result.success ? 'success' : 'error';

            let content = `[${timestamp}] ${result.success ? '‚úÖ' : '‚ùå'}\n`;

            if (result.data) {
                content += JSON.stringify(result.data, null, 2);
            }

            if (result.error) {
                content += `Error: ${result.error}`;
            }

            if (result.headers) {
                const cookies = result.headers.get('set-cookie');
                if (cookies) {
                    content += `\n\nüç™ Cookies: ${cookies ? 'YES' : 'NO'}`;
                }
            }

            element.className = `results ${statusClass}`;
            element.textContent = content;
        }

        async function testProxyHealth() {
            const query = '{ __schema { types { name } } }';
            const result = await makeGraphQLRequest(PROXY_URL, query);
            results.proxy.health = result.success;
            showResults('proxy-results', result, 'proxy');
            updateSummary();
        }

        async function testProxyLogin() {
            const query = `
                mutation {
                    webLogin(input: {
                        usernameOrEmail: "super-admin@agrinova.com"
                        password: "admin123"
                    }) {
                        accessToken
                        user {
                            id
                            name
                            role
                        }
                    }
                }
            `;
            const result = await makeGraphQLRequest(PROXY_URL, query);
            results.proxy.login = result.success;

            // Store token for auth test
            if (result.success && result.data.data.webLogin) {
                window.testToken = result.data.data.webLogin.accessToken;
                window.testCookies = result.headers.get('set-cookie');
            }

            showResults('proxy-results', result, 'proxy');
            updateSummary();
        }

        async function testProxyAuth() {
            const query = '{ myAssignments { estate { id name } } }';
            const headers = {};

            if (window.testToken) {
                headers['Authorization'] = `Bearer ${window.testToken}`;
            }

            const result = await makeGraphQLRequest(PROXY_URL, query, {}, headers);
            results.proxy.auth = result.success;
            showResults('proxy-results', result, 'proxy');
            updateSummary();
        }

        async function testDirectHealth() {
            const query = '{ __schema { types { name } } }';
            const result = await makeGraphQLRequest(DIRECT_URL, query);
            results.direct.health = result.success;
            showResults('direct-results', result, 'direct');
            updateSummary();
        }

        async function testDirectLogin() {
            const query = `
                mutation {
                    webLogin(input: {
                        usernameOrEmail: "super-admin@agrinova.com"
                        password: "admin123"
                    }) {
                        accessToken
                        user {
                            id
                            name
                            role
                        }
                    }
                }
            `;
            const result = await makeGraphQLRequest(DIRECT_URL, query);
            results.direct.login = result.success;
            showResults('direct-results', result, 'direct');
            updateSummary();
        }

        async function testDirectAuth() {
            const query = '{ myAssignments { estate { id name } } }';
            const headers = {};

            if (window.testToken) {
                headers['Authorization'] = `Bearer ${window.testToken}`;
            }

            const result = await makeGraphQLRequest(DIRECT_URL, query, {}, headers);
            results.direct.auth = result.success;
            showResults('direct-results', result, 'direct');
            updateSummary();
        }

        function testWebSocket() {
            const wsElement = document.getElementById('websocket-results');
            wsElement.className = 'results info';
            wsElement.textContent = 'Testing WebSocket connection...';

            try {
                const ws = new WebSocket(WS_URL, 'graphql-ws');

                ws.onopen = () => {
                    wsElement.className = 'results success';
                    wsElement.textContent = '‚úÖ WebSocket connection established!';
                    results.websocket = true;
                    updateSummary();

                    // Send connection init
                    ws.send(JSON.stringify({ type: 'connection_init' }));

                    // Close after 2 seconds
                    setTimeout(() => ws.close(), 2000);
                };

                ws.onerror = (error) => {
                    wsElement.className = 'results error';
                    wsElement.textContent = `‚ùå WebSocket error: ${error}`;
                    results.websocket = false;
                    updateSummary();
                };

                ws.onclose = () => {
                    if (results.websocket === null) {
                        wsElement.className = 'results info';
                        wsElement.textContent = '‚ö†Ô∏è WebSocket connection closed without success';
                        results.websocket = false;
                        updateSummary();
                    }
                };

            } catch (error) {
                wsElement.className = 'results error';
                wsElement.textContent = `‚ùå WebSocket error: ${error.message}`;
                results.websocket = false;
                updateSummary();
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');

            const proxyScore = [results.proxy.health, results.proxy.login, results.proxy.auth].filter(Boolean).length;
            const directScore = [results.direct.health, results.direct.login, results.direct.auth].filter(Boolean).length;
            const maxScore = 3;

            let summaryHTML = `
                <div>
                    <h4>üì° Proxy Connection: <span class="status-indicator ${proxyScore === maxScore ? 'status-good' : proxyScore > 0 ? 'status-pending' : 'status-bad'}"></span>${proxyScore}/${maxScore} tests</h4>
                    <ul>
                        <li>Health: ${results.proxy.health ? '‚úÖ' : '‚ùå'}</li>
                        <li>Login: ${results.proxy.login ? '‚úÖ' : '‚ùå'}</li>
                        <li>Auth: ${results.proxy.auth ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>

                <div>
                    <h4>üîó Direct Connection: <span class="status-indicator ${directScore === maxScore ? 'status-good' : directScore > 0 ? 'status-pending' : 'status-bad'}"></span>${directScore}/${maxScore} tests</h4>
                    <ul>
                        <li>Health: ${results.direct.health ? '‚úÖ' : '‚ùå'}</li>
                        <li>Login: ${results.direct.login ? '‚úÖ' : '‚ùå'}</li>
                        <li>Auth: ${results.direct.auth ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>

                <div>
                    <h4>üîå WebSocket: <span class="status-indicator ${results.websocket === true ? 'status-good' : results.websocket === false ? 'status-bad' : 'status-pending'}"></span>${results.websocket === true ? 'Connected' : results.websocket === false ? 'Failed' : 'Not Tested'}</h4>
                </div>
            `;

            // Recommendations
            if (proxyScore === maxScore && directScore === maxScore) {
                summaryHTML += '<div class="success"><strong>‚úÖ Excellent! Both proxy and direct connections work perfectly.</strong></div>';
            } else if (proxyScore === maxScore) {
                summaryHTML += '<div class="success"><strong>‚úÖ Proxy configuration works! Use this for production.</strong></div>';
            } else if (directScore === maxScore) {
                summaryHTML += '<div class="info"><strong>‚ö†Ô∏è Direct connection works, but proxy has issues. Use direct for now.</strong></div>';
            } else {
                summaryHTML += '<div class="error"><strong>‚ùå Both methods have issues. Check server configuration.</strong></div>';
            }

            summaryDiv.innerHTML = summaryHTML;
        }
    </script>
</body>
</html>