<!DOCTYPE html>
<html>
<head>
    <title>Company Dashboard Button Test (Browser)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { background: #f5f5f5; padding: 10px; font-size: 12px; overflow-x: auto; }
        .status { padding: 5px; margin: 5px 0; border-radius: 3px; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>Company Dashboard Button Test (Browser)</h1>
    <p>This test runs in the browser with proper cookie handling to verify if the GraphQL mutations work correctly.</p>

    <div class="test-section">
        <h2>Step 1: Authentication</h2>
        <button onclick="testLogin()">Login as Super Admin</button>
        <button onclick="checkAuthStatus()">Check Auth Status</button>
        <div id="auth-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Step 2: Test Companies Query</h2>
        <button onclick="testCompaniesQuery()" id="test-companies-btn" disabled>Test Companies Query</button>
        <div id="companies-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Step 3: Test Create Company Mutation</h2>
        <button onclick="testCreateCompany()" id="test-create-btn" disabled>Test Create Company</button>
        <div id="create-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Step 4: Test Update Company Mutation</h2>
        <button onclick="testUpdateCompany()" id="test-update-btn" disabled>Test Update Company</button>
        <div id="update-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Step 5: Test Delete Company Mutation</h2>
        <button onclick="testDeleteCompany()" id="test-delete-btn" disabled>Test Delete Company</button>
        <div id="delete-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Step 6: Navigate to Dashboard</h2>
        <button onclick="navigateToDashboard()" id="navigate-btn" disabled>Open Company Dashboard</button>
        <div id="navigate-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="summary" class="status info">
            <p>Click the buttons above in order to run the tests.</p>
        </div>
    </div>

    <script>
        let authToken = null;
        let testCompanyId = null;
        let testResults = {
            auth: false,
            query: false,
            create: false,
            update: false,
            delete: false
        };

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        function updateSummary() {
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const totalTests = Object.keys(testResults).length;
            
            let summary = `<h3>Test Summary: ${passedTests}/${totalTests} tests passed</h3>`;
            summary += '<ul>';
            summary += `<li>Authentication: ${testResults.auth ? '‚úÖ PASS' : '‚ùå FAIL'}</li>`;
            summary += `<li>Companies Query: ${testResults.query ? '‚úÖ PASS' : '‚ùå FAIL'}</li>`;
            summary += `<li>Create Company: ${testResults.create ? '‚úÖ PASS' : '‚ùå FAIL'}</li>`;
            summary += `<li>Update Company: ${testResults.update ? '‚úÖ PASS' : '‚ùå FAIL'}</li>`;
            summary += `<li>Delete Company: ${testResults.delete ? '‚úÖ PASS' : '‚ùå FAIL'}</li>`;
            summary += '</ul>';

            if (passedTests === totalTests) {
                summary += '<p class="success"><strong>üéâ All tests passed! The GraphQL API is working correctly.</strong></p>';
                summary += '<p>If buttons don\'t work in the UI, the issue is in the React components or state management.</p>';
            } else {
                summary += '<p class="error"><strong>‚ùå Some tests failed. This indicates issues with the GraphQL API or authentication.</strong></p>';
            }

            updateStatus('summary', summary, passedTests === totalTests ? 'success' : 'error');
        }

        async function testLogin() {
            updateStatus('auth-status', 'Attempting login...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            mutation {
                                webLogin(input: {
                                    identifier: "superadmin",
                                    password: "demo123"
                                }) {
                                    success
                                    user {
                                        id
                                        username
                                        role
                                        nama
                                        email
                                    }
                                    sessionId
                                    message
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                console.log('Login response:', data);

                if (data.errors) {
                    throw new Error(data.errors.map(e => e.message).join(', '));
                }

                if (data.data?.webLogin?.success) {
                    testResults.auth = true;
                    updateStatus('auth-status', 
                        `<strong>‚úÖ Login successful!</strong><br>
                        User: ${data.data.webLogin.user.nama} (${data.data.webLogin.user.role})<br>
                        Session ID: ${data.data.webLogin.sessionId}`, 
                        'success'
                    );

                    // Enable other test buttons
                    document.getElementById('test-companies-btn').disabled = false;
                    document.getElementById('navigate-btn').disabled = false;
                } else {
                    throw new Error(data.data?.webLogin?.message || 'Login failed');
                }
            } catch (error) {
                testResults.auth = false;
                updateStatus('auth-status', `‚ùå Login failed: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            query {
                                me {
                                    id
                                    username
                                    nama
                                    role
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                
                if (data.errors) {
                    updateStatus('auth-status', `‚ùå Not authenticated: ${data.errors[0].message}`, 'error');
                } else if (data.data?.me) {
                    updateStatus('auth-status', 
                        `‚úÖ Authenticated as: ${data.data.me.nama} (${data.data.me.role})`, 
                        'success'
                    );
                }
            } catch (error) {
                updateStatus('auth-status', `‚ùå Auth check failed: ${error.message}`, 'error');
            }
        }

        async function testCompaniesQuery() {
            updateStatus('companies-status', 'Testing companies query...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            query {
                                companies {
                                    id
                                    nama
                                    alamat
                                    telepon
                                    status
                                    users {
                                        id
                                        username
                                    }
                                    estates {
                                        id
                                        nama
                                    }
                                    createdAt
                                    updatedAt
                                }
                            }
                        `
                    })
                });

                const data = await response.json();
                console.log('Companies query response:', data);

                if (data.errors) {
                    throw new Error(data.errors.map(e => e.message).join(', '));
                }

                if (data.data?.companies) {
                    testResults.query = true;
                    updateStatus('companies-status', 
                        `‚úÖ Companies query successful!<br>Found ${data.data.companies.length} companies`, 
                        'success'
                    );

                    // Enable create test button
                    document.getElementById('test-create-btn').disabled = false;
                } else {
                    throw new Error('No companies data returned');
                }
            } catch (error) {
                testResults.query = false;
                updateStatus('companies-status', `‚ùå Companies query failed: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        async function testCreateCompany() {
            updateStatus('create-status', 'Testing create company mutation...', 'info');
            
            const testCompanyData = {
                nama: `Test Company ${Date.now()}`,
                alamat: 'Jl. Test No. 123, Jakarta',
                telepon: '+6281234567890',
                status: 'ACTIVE'
            };

            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            mutation CreateCompany($input: CreateCompanyInput!) {
                                createCompany(input: $input) {
                                    id
                                    nama
                                    alamat
                                    telepon
                                    status
                                    createdAt
                                    updatedAt
                                }
                            }
                        `,
                        variables: {
                            input: testCompanyData
                        }
                    })
                });

                const data = await response.json();
                console.log('Create company response:', data);

                if (data.errors) {
                    throw new Error(data.errors.map(e => e.message).join(', '));
                }

                if (data.data?.createCompany) {
                    testResults.create = true;
                    testCompanyId = data.data.createCompany.id;
                    updateStatus('create-status', 
                        `‚úÖ Create company successful!<br>
                        Company: ${data.data.createCompany.nama}<br>
                        ID: ${data.data.createCompany.id}`, 
                        'success'
                    );

                    // Enable update test button
                    document.getElementById('test-update-btn').disabled = false;
                } else {
                    throw new Error('No create company data returned');
                }
            } catch (error) {
                testResults.create = false;
                updateStatus('create-status', `‚ùå Create company failed: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        async function testUpdateCompany() {
            if (!testCompanyId) {
                updateStatus('update-status', '‚ùå No test company ID available. Run create test first.', 'error');
                return;
            }

            updateStatus('update-status', 'Testing update company mutation...', 'info');
            
            const updateData = {
                id: testCompanyId,
                nama: `Updated Company ${Date.now()}`,
                alamat: 'Jl. Updated No. 456, Bandung',
                telepon: '+6289876543210',
                status: 'ACTIVE'
            };

            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            mutation UpdateCompany($input: UpdateCompanyInput!) {
                                updateCompany(input: $input) {
                                    id
                                    nama
                                    alamat
                                    telepon
                                    status
                                    createdAt
                                    updatedAt
                                }
                            }
                        `,
                        variables: {
                            input: updateData
                        }
                    })
                });

                const data = await response.json();
                console.log('Update company response:', data);

                if (data.errors) {
                    throw new Error(data.errors.map(e => e.message).join(', '));
                }

                if (data.data?.updateCompany) {
                    testResults.update = true;
                    updateStatus('update-status', 
                        `‚úÖ Update company successful!<br>
                        Updated: ${data.data.updateCompany.nama}`, 
                        'success'
                    );

                    // Enable delete test button
                    document.getElementById('test-delete-btn').disabled = false;
                } else {
                    throw new Error('No update company data returned');
                }
            } catch (error) {
                testResults.update = false;
                updateStatus('update-status', `‚ùå Update company failed: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        async function testDeleteCompany() {
            if (!testCompanyId) {
                updateStatus('delete-status', '‚ùå No test company ID available. Run create test first.', 'error');
                return;
            }

            updateStatus('delete-status', 'Testing delete company mutation...', 'info');

            try {
                const response = await fetch('http://localhost:8080/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: `
                            mutation DeleteCompany($id: ID!) {
                                deleteCompany(id: $id)
                            }
                        `,
                        variables: {
                            id: testCompanyId
                        }
                    })
                });

                const data = await response.json();
                console.log('Delete company response:', data);

                if (data.errors) {
                    throw new Error(data.errors.map(e => e.message).join(', '));
                }

                if (data.data?.deleteCompany) {
                    testResults.delete = true;
                    updateStatus('delete-status', '‚úÖ Delete company successful!', 'success');
                } else {
                    throw new Error('Delete company returned false');
                }
            } catch (error) {
                testResults.delete = false;
                updateStatus('delete-status', `‚ùå Delete company failed: ${error.message}`, 'error');
            }
            
            updateSummary();
        }

        function navigateToDashboard() {
            updateStatus('navigate-status', 'Opening company dashboard...', 'info');
            window.open('http://localhost:3000/dashboard/companies', '_blank');
            updateStatus('navigate-status', '‚úÖ Dashboard opened in new tab. Check if buttons work there.', 'success');
        }

        // Initialize
        updateSummary();
    </script>
</body>
</html>